(()=>{var e={790:(e,s,t)=>{const a=t(860),r=t(0),i=t(710),o=t(17);e.exports=(new class{constructor(){this.app=a(),this.middlewares()}middlewares(){this.app.use(i()),this.app.use(a.json()),this.app.use(a.static(o.join(__dirname,"public"))),this.app.use(r),this.app.set("view engine","ejs"),this.app.set("views",o.resolve(__dirname,"./views"))}}).app},613:(e,s,t)=>{const{StatusCodes:a}=t(10),r=t(818),i=t(647),o=t(741);e.exports=new class{async register(e,s){const{email:t,password:n}=e.body;await r.isUserReg(t)?s.status(a.OK).json(i.userRegistered):await r.registerUser(t,n)?await o.sendMail()?s.status(a.OK).json(i.registered):s.status(a.OK).json(i.emailServer):s.status(a.OK).json(i.serverProblem)}async validate(e,s,t){await r.validateUser(e.params,e.query.email)?s.send("<h1>E-mail validado com sucesso!!!</h1>"):s.status(a.FORBIDDEN).json(i.invalidLink)}async authenticate(e,s,t){if(Object.keys(e.body).length)if(await r.checkUser(e.body))if(r.isValidTrue()){const t=await r.generateToken(e.headers.authorization);s.cookie("authorization",t,{httpOnly:!0,maxAge:3e4}).status(a.OK).json(i.logged)}else s.clearCookie().status(a.OK).json(i.notValidated);else s.clearCookie().status(a.OK).json(i.invalidCredentials);else await r.verifyToken(e.cookies.authorization)?s.status(a.OK).json(i.logged):s.status(a.OK).json(i.notLogged)}async forgotPass(e,s){await r.isUserReg(e.body.email)?(r.recoverAccount(),await o.sendMail()?s.status(a.OK).json(i.redefined):s.status(a.OK).json(i.emailServer)):s.status(a.OK).json(i.notValidated)}async getResetPass(e,s){const t=await r.validateUserPass(e.params,e.query.email);console.log(e.params),t?s.status(a.OK).redirect(`/reset/${e.params.uuid}?email=${e.query.email}`):(console.log("aqui"),s.status(a.FORBIDDEN).json(i.invalidLink))}async reset(e,s){}}},44:(e,s,t)=>{"use strict";const a=t(147),r=t(17),i=t(496),o=r.basename(__filename),n=t(986).production,c={};let l;l=n.use_env_variable?new i(process.env[n.use_env_variable],n):new i(n.database,n.username,n.password,n),a.readdirSync(__dirname).filter((e=>0!==e.indexOf(".")&&e!==o&&".js"===e.slice(-3))).forEach((e=>{const s=t(524)(r.join(__dirname,e))(l,i.DataTypes);c[s.name]=s})),Object.keys(c).forEach((e=>{c[e].associate&&c[e].associate(c)})),c.sequelize=l,e.exports=c},226:(e,s,t)=>{const a=t(818),{StatusCodes:r}=t(10);t(647),e.exports=async function(e,s,t){console.log(e.cookies),e.cookies.authorization?(await a.verifyToken(e.cookies.authorization)||console.log("expired"),t()):(console.log("no authorization"),t())}},0:(e,s,t)=>{const{Router:a}=t(860),r=a(),{StatusCodes:i}=t(10),o=(t(226),t(613));r.post("/register",o.register),r.post("/forgot",o.forgotPass),r.post("/reset",o.reset),r.get("/checking/:uuid",o.validate),r.get("/recover/:uuid",o.getResetPass),r.post("/login",o.authenticate),r.get("/",((e,s)=>s.status(i.OK).render("login"))),r.get("/register",((e,s)=>s.render("login"))),r.get("/forgot",((e,s)=>s.render("login"))),r.get("/reset/:uuid",((e,s)=>s.render("login"))),e.exports=r},302:(e,s,t)=>{const{user:a}=t(44);e.exports=new class{async getByEmail(e){try{return await a.findOne({where:{email:e}})||!1}catch(e){console.log(e)}}async create(e,s){try{return await a.create({email:e,password_hash:s})}catch(e){console.log(e)}}async validate(e){try{return await e.update({validated:!0})}catch(e){console.log(e)}}}},647:e=>{e.exports={notLogged:{cod:"0"},userRegistered:{cod:"1",msg:"User alredy registered, try to reset the password!"},serverProblem:{cod:"2",msg:"Sorry! We have problems in the server! Try again later."},emailServer:{cod:"3",msg:"Sorry! We have problems to send e-mail confirmation."},invalidLink:{cod:"4",msg:"Invalid link, please proceed to register."},invalidCredentials:{cod:"5",msg:"Invalid user or password."},notValidated:{cod:"6",msg:"User not validated."},logged:{cod:"7",msg:"Session valid."},logged:{cod:"8",msg:"You`re logged in.",logged:!0},registered:{cod:"9",msg:"To validate your account, check your e-mail folder and click in the link sent."},redefined:{cod:"10",msg:"To redefine your password, check your e-mail folder and click in the link sent."},newPass:{cod:"11"}}},741:(e,s,t)=>{t(142).config();const a=t(139);e.exports=new class{constructor(){this.sgMail=a.setApiKey(process.env.EMAIL_PASS),this.msg="",this.title=["Contes Store - E-mail validation","Contes Store - Reset your password"]}setMsgInfo(e,s,t,a){let r="";r="checking"===t?"Clique aqui para validar seu email":"Clique aqui para redefinir a sua senha",this.msg={to:s,from:"contes.dev@hotmail.com",subject:this.title[a],html:`<a href="http://localhost:8080/${t}/${e}?email=${s}">${r}</a>`}}sendMail(){return this.sgMail.send(this.msg).then((()=>(console.log("Email sent"),!0))).catch((e=>(console.log(e),!1)))}printMsg(){console.log(this.msg)}}},818:(e,s,t)=>{const a=t(302),r=t(432),i=t(741),o=(t(113),t(344)),{MailService:n}=t(139);e.exports=new class{constructor(){this.user="",this.secretKey="a5638a895ab58685bdd260cd531437e603c17c48bba1b57963881fc09012c6ad6fbd31383bdb9cec454b8c37d52aea8ffb47a3336004e716d329d429d1f17502"}async checkUser({email:e,password:s}){if(e&&s){const t=await this.isUserReg(e),a=await this.isPassCorrect(s);return!(!t||!a)}return!1}async generateToken(e){const{uuid:s,email:t}=this.user.dataValues,a={user:{uuid:s,email:t}};return o.sign(a,this.secretKey,{expiresIn:"30s"})}async verifyToken(e){try{return o.verify(e,this.secretKey),!0}catch(e){return console.log(e),!1}}async registerUser(e,s){const t=await this.getHashPass(s),r=await a.create(e,t);return!!r&&(i.setMsgInfo(r.dataValues.uuid,e,"checking",0),!0)}async recoverAccount(){return i.setMsgInfo(this.user.dataValues.uuid,this.user.dataValues.email,"recover",1),!0}async validateUser(e,s){try{const t=await this.isUserReg(s),a=this.isUUIDCorrect(e),r=this.isValidTrue();return!(!a||!t||r)&&!!this.updateValidUser()}catch(e){console.log(e)}}async validateUserPass(e,s){try{const t=await this.isUserReg(s),a=this.isUUIDCorrect(e),r=this.isValidTrue();return!!(a&&t&&r)}catch(e){console.log(e)}}async updateValidUser(){return!!await a.validate(this.user)}async getHashPass(e){return await r.hash(e,10)}async isUserReg(e){return this.user=await a.getByEmail(e),!!this.user}isUUIDCorrect({uuid:e}){return this.user.dataValues.uuid===e}async isPassCorrect(e){try{return await r.compare(e,this.user.dataValues.password_hash)}catch(e){return console.log(e),!1}}isValidTrue(){return!!this.user.dataValues.validated}}},524:e=>{function s(e){var s=new Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}s.keys=()=>[],s.resolve=s,s.id=524,e.exports=s},139:e=>{"use strict";e.exports=require("@sendgrid/mail")},432:e=>{"use strict";e.exports=require("bcryptjs")},710:e=>{"use strict";e.exports=require("cookie-parser")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},10:e=>{"use strict";e.exports=require("http-status-codes")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},496:e=>{"use strict";e.exports=require("sequelize")},113:e=>{"use strict";e.exports=require("crypto")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")},986:e=>{"use strict";e.exports=JSON.parse('{"development":{"username":"postgres","password":"5noSRIdmm@","database":"usuarios","host":"127.0.0.1","dialect":"postgres"}}')}},s={};function t(a){var r=s[a];if(void 0!==r)return r.exports;var i=s[a]={exports:{}};return e[a](i,i.exports,t),i.exports}t.o=(e,s)=>Object.prototype.hasOwnProperty.call(e,s),(()=>{const e=t(790),{sequelize:s}=t(44),a=8080|process.env.PORT;e.listen(a,(async()=>{console.log(`Server listening at http://localhost:${a}`),await s.authenticate(),console.log("Database connected!")}))})()})();